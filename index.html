<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa Face Swap</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        canvas { border: 8px solid #d42426; border-radius: 15px; max-width: 100%; margin-top: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .controls { background: white; padding: 30px; border-radius: 15px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-top: 5px solid #228b22; }
        button { background: #228b22; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input[type="file"] { margin: 10px 0; }
        #status { display: block; margin-top: 10px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <h1>üéÖ Santa Face Swap üéÑ</h1>
    
    <div class="controls">
        <p>Step 1: Wait for "Ready" status.<br>Step 2: Upload a photo of a face!</p>
        <input type="file" id="imageUpload" accept="image/*" disabled>
        <span id="status">‚è≥ Loading AI Models...</span>
        <br>
        <button id="downloadBtn" style="display:none;">üéÅ Download Santa Photo</button>
    </div>

    <div id="container">
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const downloadBtn = document.getElementById('downloadBtn');

        // Load Santa Template
        const santaImg = new Image();
        santaImg.crossOrigin = "anonymous";
        // This is a reliable Santa frame image
        santaImg.src = 'https://img.freepik.com/free-vector/santa-claus-holding-empty-frame_1308-78243.jpg';

        async function loadModels() {
            try {
                // Using a direct CDN that specifically allows CORS for these models
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                
                status.innerText = "‚úÖ Ready! Upload a photo.";
                status.style.color = "#228b22";
                imageUpload.disabled = false;
            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå Error loading AI. Try refreshing.";
                status.style.color = "#d42426";
            }
        }

        imageUpload.addEventListener('change', async () => {
            if (!imageUpload.files[0]) return;
            
            status.innerText = "‚ú® Magic in progress...";
            downloadBtn.style.display = "none";

            // Prepare Canvas
            canvas.width = santaImg.width;
            canvas.height = santaImg.height;
            ctx.drawImage(santaImg, 0, 0);

            // Process User Image
            const img = await faceapi.bufferToImage(imageUpload.files[0]);
            const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

            if (detection) {
                const box = detection.detection.box;
                
                // Santa's face location on THIS specific template
                const targetX = 330; 
                const targetY = 180;
                const targetWidth = 280;
                const targetHeight = 320;

                // Clip into a nice oval shape
                ctx.save();
                ctx.beginPath();
                ctx.ellipse(targetX + targetWidth/2, targetY + targetHeight/2, targetWidth/2, targetHeight/2, 0, 0, Math.PI * 2);
                ctx.clip();
                
                // Draw the face
                ctx.drawImage(img, box.x, box.y, box.width, box.height, targetX, targetY, targetWidth, targetHeight);
                ctx.restore();
                
                status.innerText = "Ho Ho Ho! It worked!";
                downloadBtn.style.display = "inline-block";
            } else {
                status.innerText = "üö´ No face found. Use a clearer photo!";
            }
        });

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'my-santa-photo.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        loadModels();
    </script>
</body>
</html>
